function createRenderTarget(){return new THREE.WebGLRenderTarget(1,1,{wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,format:THREE.RGBAFormat,stencilBuffer:!1,depthBuffer:!0})}function initScene(){function e(e){return Math.atan2(e.z,-e.x)}function t(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}for(var r=isMobile.any?128:256,a=isMobile.any?128:256,n=new Float32Array(r*a*4),i=1,o=0,d=r*a;o<d;o++){var E=2*Math.random()*Math.PI,s=2*Math.random()-1,h=Math.acos(s);i=.85+.15*Math.random(),n[4*o]=i*Math.sin(h)*Math.cos(E),n[4*o+1]=i*Math.sin(h)*Math.sin(E),n[4*o+2]=i*Math.cos(h),n[4*o+3]=100*Math.random()}var l=new THREE.DataTexture(n,r,a,THREE.RGBAFormat,THREE.FloatType);l.minFilter=THREE.NearestFilter,l.magFilter=THREE.NearestFilter,l.needsUpdate=!0,helper.attach(l,"original");var p=new THREE.WebGLRenderTarget(r,a,{wrapS:THREE.ClampToEdgeWrapping,wrapT:THREE.ClampToEdgeWrapping,minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.HalfFloatType,stencilBuffer:!1,depthBuffer:!1,generateMipmaps:!1});targets=[p,p.clone()],simulationShader=new THREE.RawShaderMaterial({uniforms:{original:{type:"t",value:l},positions:{type:"t",value:l},time:{type:"f",value:0}},vertexShader:document.getElementById("simulation-vs").textContent,fragmentShader:document.getElementById("simulation-fs").textContent,side:THREE.DoubleSide}),rtScene=new THREE.Scene,rtCamera=new THREE.OrthographicCamera(-r/2,r/2,-a/2,a/2,-500,1e3),rtQuad=new THREE.Mesh(new THREE.PlaneBufferGeometry(r,a),simulationShader),rtScene.add(rtQuad),renderer.render(rtScene,rtCamera,p),helper.attach(targets[0],"positions"),helper.attach(targets[1],"positions");for(var c=new THREE.BufferGeometry,m=new Float32Array(r*a*3*3),u=0,w=0;w<a;w++)for(var T=0;T<r;T++)m[u]=T/r,m[u+1]=w/r,m[u+2]=0,u+=3;c.addAttribute("position",new THREE.BufferAttribute(m,3));var R=new THREE.RawShaderMaterial({uniforms:{positions:{type:"t",value:p}},vertexShader:document.getElementById("particle-vs").textContent,fragmentShader:document.getElementById("particle-fs").textContent});mesh=new THREE.Points(c,R);var g=createRenderTarget(),H=4096;g.setSize(H,H/2),textureFBO=[g,g.clone()],textureFBO[0].texture.wrapS=textureFBO[0].texture.wrapT=THREE.RepeatWrapping,textureFBO[1].texture.wrapS=textureFBO[1].texture.wrapT=THREE.RepeatWrapping,helper.attach(textureFBO[0],"texture"),helper.attach(textureFBO[1],"texture"),textureShader=new THREE.RawShaderMaterial({uniforms:{streakType:{type:"f",value:streakType},positions:{type:"t",value:textureFBO[targetTexture].texture},dimensions:{type:"t",value:new THREE.Vector2(H,H/2)}},vertexShader:document.getElementById("texture-vs").textContent,fragmentShader:document.getElementById("texture-fs").textContent,side:THREE.DoubleSide,transparent:!0}),orthoScene=new THREE.Scene,orthoCamera=new THREE.OrthographicCamera(-g.width/2,g.width/2,-g.height/2,g.height/2,-1e3,1e3),orthoMesh=new THREE.Points(c,textureShader),orthoScene.add(orthoMesh),clearShader=new THREE.RawShaderMaterial({uniforms:{texture:{type:"t",value:l.texture}},vertexShader:document.getElementById("clear-vs").textContent,fragmentShader:document.getElementById("clear-fs").textContent,side:THREE.DoubleSide,transparent:!0}),orthoQuad=new THREE.Mesh(new THREE.PlaneBufferGeometry(g.width,g.height),clearShader),orthoScene.add(orthoQuad);var S=new THREE.IcosahedronBufferGeometry(100,5),f=new THREE.HemisphereLight(16751964,6073855,1);scene.add(f);var x=new THREE.AmbientLight(2105376),v=new THREE.SpotLight(16777215,.5,100,.25,.2,.1);v.position.set(0,40,0),v.castShadow=!1,v.shadow.mapSize.width=v.shadow.mapSize.height=1024,scene.add(v);var y=new THREE.SpotLight(16777215,.5,100,.5,.2,.1);y.position.set(-10,20,4),y.castShadow=!1,y.shadow.mapSize.width=y.shadow.mapSize.height=1024,scene.add(y),sphere=new THREE.Mesh(S,new THREE.MeshBasicMaterial({map:g.texture,transparent:!1,side:THREE.DoubleSide})),scene.add(sphere)}function init(){webglcontainer=document.getElementById("webglcontainer"),scene=new THREE.Scene,camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e4),camera.position.set(0,0,90),camera.target=new THREE.Vector3(0,0,0),camera.lookAt(camera.target),scene.add(camera),renderer=new THREE.WebGLRenderer({antialias:!1,preserveDrawingBuffer:!0}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setClearColor(0,1),webglcontainer.appendChild(renderer.domElement),helper=new FBOHelper(renderer),helper.show(!1),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFShadowMap,initScene(),onWindowResized(),window.addEventListener("resize",onWindowResized),animate()}function onWindowResized(e){var t=webglcontainer.clientWidth,r=webglcontainer.clientHeight;renderer.setSize(t,r),camera.aspect=t/r,camera.updateProjectionMatrix()}var webglcontainer,renderer,camera,controls,scene,sphere,mesh,targets,positionShader,simulationShader,textureShader,clearShader,rtScene,rtQuad,rtCamera,orthoScene,orthoMesh,orthoQuad,orthoCamera,targetPos=0,targetTexture=0,textureFBO,helper,streakType=.1,webglcontainer=document.getElementById("webglcontainer");window.addEventListener("load",init);